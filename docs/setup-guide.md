# セットアップガイド

このガイドでは、DAM★とも APIを使用するために必要な `cdmCardNo` の取得方法を説明します。

## 必要なもの

- DAM★ともアカウント
- ブラウザ（Chrome、Firefox、Edge など）
- 約5分の作業時間

## cdmCardNo の取得方法

### ステップ1: DAM★ともにログイン

1. ブラウザで [DAM★とも公式サイト](https://www.clubdam.com) にアクセス
2. アカウントでログイン

### ステップ2: 開発者ツールを開く

**Chrome / Edge の場合:**
- `F12` キーを押す
- または、右クリック → 「検証」を選択

**Firefox の場合:**
- `F12` キーを押す
- または、右クリック → 「要素を調査」を選択

**Safari の場合:**
- まず「開発」メニューを有効にする必要があります
  1. Safari → 環境設定 → 詳細
  2. 「メニューバーに"開発"メニューを表示」にチェック
- `Command + Option + I` を押す

### ステップ3: ネットワークタブを開く

1. 開発者ツールの上部にある **「Network」（ネットワーク）** タブをクリック
2. フィルター機能があれば **「XHR」または「Fetch/XHR」** を選択（推奨）

### ステップ4: カロリー履歴ページにアクセス

1. DAM★ともサイト内で、カロリー履歴ページに移動
   - URL例: `https://www.clubdam.com/app/damtomo/member/info/CalorieHistoryList.do`
   - メニューから「マイページ」→「カロリー履歴」などで到達可能

2. ページが読み込まれると、ネットワークタブに複数のリクエストが表示されます

### ステップ5: CalorieHistoryListXML.do を探す

1. ネットワークタブのリクエスト一覧から以下を探します:
   ```
   CalorieHistoryListXML.do
   ```

2. このリクエストをクリック

### ステップ6: レスポンスから cdmCardNo を取得

1. 右側のパネルで **「Response」（レスポンス）** タブをクリック
2. XMLデータが表示されます
3. その中から以下のような行を探します:
   ```xml
   <cdmCardNo>YOUR_CDM_CARD_NO_HERE</cdmCardNo>
   ```

4. **`<cdmCardNo>` と `</cdmCardNo>` の間にある文字列**をコピー
   - 例: `YOUR_CDM_CARD_NO_HERE`

### 補足: 他の方法でも取得可能

以下のAPIレスポンスからも同じ値を取得できます:
- `GetScoringAiListXML.do` のレスポンス内
- `GetScoringHeartsListXML.do` のレスポンス内

いずれも、採点履歴などのページを開くと自動的にリクエストされます。

## セットアップ

### 1. リポジトリをクローン

```bash
git clone <このリポジトリのURL>
cd karaoke-api
```

### 2. 依存関係をインストール

```bash
npm install
```

### 3. 環境変数ファイルを作成

```bash
cp .env.example .env
```

### 4. .env ファイルを編集

取得した `cdmCardNo` を設定します:

```
CDM_CARD_NO=YOUR_CDM_CARD_NO_HERE
```

**注意:** 上記は例です。あなた自身の値に置き換えてください。

### 5. 実行

```bash
npm run dev
```

## トラブルシューティング

### エラー: "CDMカード番号のスクランブル解除に失敗しました"

- `cdmCardNo` が正しくない可能性があります
- 手順に従って、もう一度取得してください
- コピー時に余分なスペースや改行が含まれていないか確認

### エラー: "CDM_CARD_NO が設定されていません"

- `.env` ファイルが存在するか確認
- `.env` ファイル内の `CDM_CARD_NO=` の後に値が設定されているか確認

### ネットワークタブに CalorieHistoryListXML.do が表示されない

1. ネットワークタブを開いた状態でページをリロード（`Ctrl+R` または `Cmd+R`）
2. 採点履歴ページなど、別のページを試す
3. フィルターを「All」に変更して全てのリクエストを表示

## セキュリティについて

- `cdmCardNo` は **あなたのアカウントにアクセスするための認証情報** です
- `.env` ファイルは **絶対に公開しない** でください
- Git にコミットしないでください（`.gitignore` に含まれています）
- 他の人と共有しないでください

## よくある質問

### Q: cdmCardNo はどのくらいの頻度で変わりますか？

A: 通常は変わりません。アカウントに紐付いた固定値です。

### Q: この方法は公式にサポートされていますか？

A: いいえ。これは非公式の方法です。DAM★ともの利用規約を守って使用してください。

### Q: 複数のアカウントを管理できますか？

A: はい。アカウントごとに異なる `cdmCardNo` を使用して、複数のインスタンスを実行できます。

## cdmToken の取得（DX-G使用時のみ）

DX-Gを使用する場合は、追加で `cdmToken` が必要です。

### 取得手順

1. **DAM★ともにログイン**
2. **DX-Gの採点履歴ページを開く**
3. **開発者ツール（F12）→ Networkタブ**
4. **ページをリロード**
5. **`GetScoringDxgListXML.do` を探す**
6. **Query String Parameters** の `cdmToken` の値をコピー

### .envに追加

```
CDM_TOKEN=取得したcdmToken
```

### 注意

- `cdmToken` はセッションごとに変わる可能性があります
- エラーが出た場合は再取得してください
- AiとHeartsには不要です（DX-Gのみ）

## 次のステップ

- [APIリファレンス](./api-reference.md) - 利用可能なAPIメソッドの詳細
- [サンプルコード](../examples/) - 実装例
- [README](../README.md) - プロジェクト概要
